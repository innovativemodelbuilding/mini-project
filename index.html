<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOYAL's M.C.Q</title>
    <link rel="stylesheet" href="css/index.css" />
   
    <meta name="viewport" content="width=device-width, initial-scale=1">

  </head>
  <body class="index-page">
    <!-- Header -->
    <div id="site-header-placeholder"></div>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-card">
        <h1>LOYAL's MCQ</h1>
        <p>Welcome to LOYAL M.C.Q's!<br> Pick your level and letâ€™s learn.</p>
      </div>
    </section>

    <!-- Level Links -->
    <nav id="levels" class="index card-grid">
      
      <a href="./start-page/subject_level1.html" class="card" data-level="I">
        <div class="card-icon">âž•</div>
        <h3 class="card-title">Level - 1</h3>
        <p class="card-desc">Adding & subtracting, greater & less than.</p>
      </a>
    </nav>

    <!--  Footer -->
    <div id="site-footer-placeholder"></div>

    <!-- js for header & footer -->
    <script src="js/script.js"></script>
    <script src="js/partials.js"></script>
    
<!-- ====== LoyalMCQs â€” ML FAQ Chatbot (Browser-only, TF.js + USE) ====== -->
<style>
  :root { --pri:#e11d48; --bg:#fff; --txt:#222; --mut:#666; --sh:0 12px 30px rgba(0,0,0,.18); --r:16px; }
  .cb-fab{position:fixed;right:20px;bottom:20px;z-index:9999;width:56px;height:56px;border-radius:50%;
    background:var(--pri);color:#fff;border:0;display:grid;place-items:center;cursor:pointer;box-shadow:var(--sh);}
  .cb-panel{position:fixed;right:20px;bottom:90px;z-index:9998;width:min(360px,calc(100vw - 32px));
    max-height:min(70vh,620px);background:var(--bg);color:var(--txt);border-radius:var(--r);box-shadow:var(--sh);
    display:none;overflow:hidden;}
  .cb-panel.open{display:grid;grid-template-rows:auto 1fr auto;}
  .cb-header{padding:12px 16px;background:var(--pri);color:#fff;display:flex;gap:10px;align-items:center;}
  .cb-avatar{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.2);display:grid;place-items:center;font-weight:700}
  .cb-body{padding:14px;overflow:auto;display:grid;gap:10px;background:#fafafa;}
  .cb-bubble{max-width:85%;padding:10px 12px;border-radius:14px;line-height:1.35;box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .cb-bubble.bot{background:#fff;border-top-left-radius:4px}
  .cb-bubble.user{background:#ffe4e6;border-top-right-radius:4px;justify-self:end}
  .cb-options{display:grid;gap:8px}
  .cb-option-btn{padding:10px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;text-align:left;cursor:pointer}
  .cb-typing{font-size:12px;color:var(--mut)}
  .cb-footer{display:grid;gap:8px;padding:10px 12px;background:#fff;border-top:1px solid #eee}
  .cb-row{display:flex;gap:8px}
  .cb-input{flex:1;border:1px solid #e0e0e0;border-radius:10px;padding:10px}
  .cb-send{border:0;background:var(--pri);color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .cb-conf{height:6px;background:#eee;border-radius:999px;overflow:hidden}
  .cb-conf > i{display:block;height:100%;background:var(--pri);width:0%}
  .cb-small{font-size:12px;color:#444}
  .cb-option-btn {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #e6e6e6;
  background: #ffffff;   /* white background */
  text-align: left;
  cursor: pointer;
  color: #000000;        /* force text to black */
}

.cb-option-btn:hover {
  background: #afafaf;   /* light hover background */
  color: #000000;        /* keep text black even on hover */
}

</style>

<button class="cb-fab" id="cbFab" aria-label="Open chatbot" title="Chat">
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M21 12c0 4.418-4.03 8-9 8-1.02 0-1.999-.14-2.91-.4L3 21l1.47-4.41C3.54 15.2 3 13.66 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8Z" fill="currentColor"/></svg>
</button>

<div class="cb-panel" id="cbPanel" role="dialog" aria-modal="true" aria-labelledby="cbTitle">
  <div class="cb-header">
    <div class="cb-avatar" aria-hidden="true">L</div>
    <div>
      <div id="cbTitle" style="font-weight:700">LoyalBot â€” LoyalMCQs</div>
      <div style="font-size:12px;opacity:.95">On-device ML intent matcher</div>
    </div>
  </div>

  <div class="cb-body" id="cbBody">
    <div class="cb-bubble bot">ðŸ‘‹ Hello! Iâ€™m <b>LoyalBot</b>. How can I help?</div>
    <div class="cb-options" id="cbOptions" aria-label="Quick questions"></div>
  </div>

  <div class="cb-footer">
    <div class="cb-row">
      <input id="cbInput" class="cb-input" placeholder="Type your questionâ€¦ e.g., How to start? or 2+2" />
      <button id="cbSend" class="cb-send">Ask</button>
    </div>
    <div class="cb-conf" title="Classifier confidence"><i id="cbConfBar"></i></div>
    <div class="cb-small">All answers are local â€¢ No data leaves your device</div>
  </div>
</div>

<!-- Scripts (swap to local copies for offline demo) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

<script>
/** ================= BRANDING ================== */
const BRAND = {
  botName: "LoyalBot",
  siteName: "LoyalMCQs",
  supportEmail: "support@loyalmcqs.example",
  supportPhone: "+91 12345 67890",
  supportHours: "Monâ€“Fri, 10amâ€“6pm (IST)"
};

/** ============ INTENTS (ADD MORE HERE) ============
 * id: unique string
 * answerHtml: canned response (HTML ok)
 * examples: training phrases to define the semantic neighborhood
 */
const INTENTS = [
  {
    id: 'about',
    answerHtml:
      `${BRAND.siteName} is a kid-friendly quiz platform that builds core skills with short, fun questions. Quick practice, clean UI, no sign-in in this MVP.`,
    examples: [
      "what is this website about",
      "tell me about loyalmcqs",
      "what do you do",
      "what does this site stand for",
      "explain loyal mcqs"
    ]
  },
  {
    id: 'getting_started',
    answerHtml:
      `Go to <b>Level â†’ Subject â†’ Skill</b> and tap <i>Start</i>. Youâ€™ll get 20 shuffled questions. Replay a skill anytime for a new set.`,
    examples: [
      "how to start",
      "how do i use this",
      "where do i begin",
      "how to play the quiz",
      "how does it work",
      "how to get started"
    ]
  },
  {
    id: 'privacy',
    answerHtml:
      `We donâ€™t collect personal data in this MVP. Content is curated for kids. We recommend supervised use on shared/school devices.`,
    examples: [
      "is my data safe",
      "privacy policy",
      "do you collect data",
      "is this safe for kids",
      "security concerns"
    ]
  },
  {
    id: 'support',
    answerHtml:
      `Email <a href="mailto:${BRAND.supportEmail}">${BRAND.supportEmail}</a> or call
       <a href="tel:${BRAND.supportPhone}">${BRAND.supportPhone}</a> (${BRAND.supportHours}).`,
    examples: [
      "i need help",
      "contact support",
      "phone number",
      "email address",
      "how to reach you",
      "support hours"
    ]
  },
  {
    id: 'bot_name',
    answerHtml: `Iâ€™m <b>${BRAND.botName}</b>, your helper for ${BRAND.siteName}.`,
    examples: [
      "what is your name",
      "who are you",
      "bot name",
      "your name please",
      "introduce yourself"
    ]
  },
  {
    id: 'greeting',
    answerHtml: `Hi there! Iâ€™m <b>${BRAND.botName}</b>. Ask me about ${BRAND.siteName} or use the quick buttons.`,
    examples: [
      "hi",
      "hello",
      "hey",
      "good morning",
      "good evening"
    ]
  },
  {
    id: 'how_are_you',
    answerHtml: `Iâ€™m running great and ready to help. What do you need?`,
    examples: [
      "how are you",
      "how is it going",
      "how r u"
    ]
  },
  {
    id: 'user_name',
    answerHtml: `I donâ€™t know your name yet. I donâ€™t collect personal data in this version.`,
    examples: [
      "what is my name",
      "do you know my name",
      "who am i"
    ]
  },
  {
    id: 'Who made you',
    answerHtml:
      `LOYAL MCQ's is made by Mustafa, Rayyan and Ahmed. This EdTech Platform is made for children to help them study`,
    examples: [
      "owner",
      "who made you",
      "who are the developers",
      "how are you"
    ]
  }
];

/** Quick buttons (top 4 for kids). You can add more or change labels. */
const QUICK_BUTTONS = [
  ["About LoyalMCQs", "about"],
  ["How to get started", "getting_started"],
  ["Privacy & safety", "privacy"],
  ["Contact support", "support"]
];

/** ========== UI wiring ========== */
const fab = document.getElementById('cbFab');
const panel = document.getElementById('cbPanel');
const body = document.getElementById('cbBody');
const optionsBox = document.getElementById('cbOptions');
const input = document.getElementById('cbInput');
const sendBtn = document.getElementById('cbSend');
const confBar = document.getElementById('cbConfBar');

function addBubble(html, who='bot'){ const d=document.createElement('div'); d.className=`cb-bubble ${who}`;
  d.innerHTML=html; body.appendChild(d); body.scrollTop=body.scrollHeight; }

function renderQuickButtons(){
  optionsBox.innerHTML='';
  QUICK_BUTTONS.forEach(([label, id])=>{
    const b=document.createElement('button'); b.className='cb-option-btn'; b.textContent=label;
    b.onclick=()=>{ addBubble(label,'user'); answerIntent(id, 0.95); };
    optionsBox.appendChild(b);
  });
}

fab.onclick = ()=> panel.classList.toggle('open');
document.addEventListener('click', (e)=>{
  if(!panel.classList.contains('open')) return;
  const inside = panel.contains(e.target)||fab.contains(e.target);
  if(!inside) panel.classList.remove('open');
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape' && panel.classList.contains('open')) panel.classList.remove('open');
});

/** ========== Safe math handler (before ML) ==========
 * Supports + - * / parentheses and spaces only, up to 64 chars.
 * Returns null if not a simple math expression.
 */
function trySimpleMath(q){
  const s = q.replace(/ /g,'');
  if(!/^[\d\+\-\*\/\(\)\.]{1,64}$/.test(s)) return null;
  // Simple shunting-yard evaluator
  try{
    const ops = [], out = [];
    const prec = { '+':1,'-':1,'*':2,'/':2 };
    function apply(){
      const op = ops.pop(), b = out.pop(), a = out.pop();
      let r = 0;
      if(op==='+') r=a+b; else if(op==='-') r=a-b; else if(op==='*') r=a*b; else r=a/b;
      out.push(r);
    }
    // tokenize
    const tokens = s.match(/\d+(\.\d+)?|[+\-*/()]/g);
    for(const t of tokens){
      if(/^\d/.test(t)) out.push(parseFloat(t));
      else if(t in prec){
        while(ops.length && ops[ops.length-1] in prec && prec[ops[ops.length-1]]>=prec[t]) apply();
        ops.push(t);
      } else if(t==='(') ops.push(t);
      else if(t===')'){
        while(ops.length && ops[ops.length-1]!=='(') apply();
        if(ops.pop()!=='(') return null;
      }
    }
    while(ops.length){ if(!(ops[ops.length-1] in prec)) return null; apply(); }
    const val = out.pop();
    if(out.length!==0 || !isFinite(val)) return null;
    return Math.round((val + Number.EPSILON)*1e6)/1e6; // 6 d.p. cap
  }catch{ return null; }
}

/** ========== ML: USE intent classifier ========== */
let useModel = null;
let intentEmbeds = null;  // centroid per intent

function cosineSim(a, b){
  const dot = a.reduce((s,v,i)=>s + v*b[i], 0);
  const na = Math.sqrt(a.reduce((s,v)=>s + v*v, 0));
  const nb = Math.sqrt(b.reduce((s,v)=>s + v*v, 0));
  return dot/(na*nb + 1e-8);
}

async function loadAndPrepare(){
  addBubble("â³ Loading on-device language modelâ€¦");
  useModel = await use.load();
  // Compute centroid embeddings
  const allTexts = INTENTS.flatMap(it=>it.examples);
  const embeds = await useModel.embed(allTexts);
  const dim = embeds.shape[1];
  intentEmbeds = {};
  let offset = 0;
  INTENTS.forEach((it)=>{
    const n = it.examples.length;
    const slice = embeds.slice([offset,0],[n,dim]).arraySync();
    offset += n;
    const centroid = new Array(dim).fill(0);
    slice.forEach(vec=>{ for(let i=0;i<dim;i++) centroid[i]+=vec[i]; });
    for(let i=0;i<dim;i++) centroid[i]/=n;
    intentEmbeds[it.id] = centroid;
  });
  addBubble("âœ… Model ready. Ask me anything about LoyalMCQs or use the buttons.");
  renderQuickButtons();
}

async function classify(text){
  const e = await useModel.embed([text]);
  const v = e.arraySync()[0];
  let best = null, bestScore = -1;
  for(const it of INTENTS){
    const score = cosineSim(v, intentEmbeds[it.id]);
    if(score>bestScore){ best = it; bestScore = score; }
  }
  return {intent: best, score: bestScore};
}

function setConfidence(p){ confBar.style.width = Math.max(0, Math.min(1,p))*100 + '%'; }

async function answerFreeText(q){
  addBubble(q, 'user');

  // 1) Handle simple math locally (no ML needed)
  const math = trySimpleMath(q);
  if(math !== null){
    setConfidence(1);
    addBubble(`Result: <b>${math}</b>`, 'bot');
    return;
  }

  // 2) Otherwise, classify with USE
  const {intent, score} = await classify(q.toLowerCase());
  if(!intent || score < 0.35){
    setConfidence(0);
    addBubble(`Iâ€™m not sure I got that. Try rephrasing or use the quick buttons below.`, 'bot');
    renderQuickButtons();
    return;
  }
  setConfidence(score);
  addBubble(intent.answerHtml, 'bot');
}

function answerIntent(id, forceConf=0.9){
  const it = INTENTS.find(x=>x.id===id);
  setConfidence(forceConf);
  addBubble(it.answerHtml, 'bot');
}

sendBtn.onclick = ()=>{ const q=input.value.trim(); if(!q) return; input.value=''; answerFreeText(q); };
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendBtn.click(); });

// Lazy-load model first time the panel opens
let loaded = false;
fab.addEventListener('click', ()=>{
  if(!loaded){ loaded=true; loadAndPrepare(); }
});
</script>
<!-- ====== End LoyalMCQs ML Chatbot ====== -->


  </body>
</html>

